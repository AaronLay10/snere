version: '3.8'

# Development environment overrides
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # API - Development with hot-reload
  sentient-api-1:
    build:
      context: ./services/api
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/api:/app
      - /app/node_modules
    ports:
      - "3000:3000"
      - "9229:9229"  # Debug port
    environment:
      NODE_ENV: development
      CORS_ORIGIN: http://localhost:3002,http://localhost,http://localhost:3000,http://127.0.0.1:3002,http://192.168.2.3,http://192.168.2.3:3002,http://192.168.2.3:80
    command: npm run dev

  sentient-api-2:
    build:
      context: ./services/api
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/api:/app
      - /app/node_modules
    ports:
      - "3001:3000"
      - "9228:9229"  # Debug port (different from api-1)
    environment:
      NODE_ENV: development
      CORS_ORIGIN: http://localhost:3002,http://localhost,http://localhost:3000,http://127.0.0.1:3002,http://192.168.2.3,http://192.168.2.3:3002,http://192.168.2.3:80
    command: npm run dev

  # Scene Executor - Development with TypeScript hot-reload
  scene-executor:
    build:
      context: ./services/executor-engine
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/executor-engine:/app
      - /app/node_modules
      - ./config:/opt/sentient/config:ro
    ports:
      - "3004:3004"
      - "9230:9230"  # Debug port
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://sentient_dev:dev_password@postgres:5432/sentient_dev
      MQTT_URL: mqtt://mosquitto:1883
      MQTT_USERNAME: paragon_devices
      MQTT_PASSWORD: T@t0nk@-93
    command: npm run dev

  # Device Monitor - Development with hot-reload
  device-monitor:
    build:
      context: ./services/device-monitor
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/device-monitor:/app
      - /app/node_modules
    ports:
      - "3003:3003"
      - "9231:9231"  # Debug port
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://sentient_dev:dev_password@postgres:5432/sentient_dev
      MQTT_URL: mqtt://mosquitto:1883
      MQTT_USERNAME: paragon_devices
      MQTT_PASSWORD: T@t0nk@-93
    command: npm run dev

  # Web Frontend - Development with Vite HMR
  sentient-web:
    build:
      context: ./services/sentient-web
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/sentient-web:/app
      - /app/node_modules
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: development
      # Use empty VITE_API_URL to make requests relative (via nginx proxy)
      VITE_API_URL: ""
    command: npm run dev -- --host 0.0.0.0 --port 3002

  # PostgreSQL - Development with exposed port
  postgres:
    ports:
      - "5432:5432"
    environment:
      # Development database credentials
      POSTGRES_DB: sentient_dev
      POSTGRES_USER: sentient_dev
      POSTGRES_PASSWORD: dev_password

  # Mosquitto - Development with exposed ports
  mosquitto:
    ports:
      - "1883:1883"
      - "9001:9001"

  # Nginx - Use local config for development
  nginx:
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
    ports:
      - "80:80"

  # Grafana - Development mode
  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "true"
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
    ports:
      - "3200:3000"

  # Prometheus - Exposed for development
  prometheus:
    ports:
      - "9090:9090"

  # Loki - Exposed for development
  loki:
    ports:
      - "3100:3100"