#include <ParagonMQTT.h>

const char *deviceID = "Music"; // Unique device identifier
const char *roomID = "Clockwork";

const int powerLED = 13;

// Pin Assignments for buttons
const int button1 = 0;
const int button2 = 1;
const int button3 = 2;
const int button4 = 3;
const int button5 = 4;
const int button6 = 5;

// Button state variables
bool buttonState1 = false, buttonState2 = false, buttonState3 = false;
bool buttonState4 = false, buttonState5 = false, buttonState6 = false;
bool lastButtonState1 = false, lastButtonState2 = false, lastButtonState3 = false;
bool lastButtonState4 = false, lastButtonState5 = false, lastButtonState6 = false;

// Debounce timing
unsigned long lastDebounceTime1 = 0, lastDebounceTime2 = 0, lastDebounceTime3 = 0;
unsigned long lastDebounceTime4 = 0, lastDebounceTime5 = 0, lastDebounceTime6 = 0;
const unsigned long debounceDelay = 50; // 50ms debounce delay

// Heartbeat timing
unsigned long lastHeartbeat = 0;
const unsigned long heartbeatInterval = 5000; // 5 seconds

void setup()
{
  // On-board LED setup
  pinMode(powerLED, OUTPUT);
  digitalWrite(powerLED, HIGH);

  Serial.begin(115200);

  // Button setup with internal pull-up resistors
  Serial.println("Setting up Button Sensors...");
  pinMode(button1, INPUT_PULLUP);
  pinMode(button2, INPUT_PULLUP);
  pinMode(button3, INPUT_PULLUP);
  pinMode(button4, INPUT_PULLUP);
  pinMode(button5, INPUT_PULLUP);
  pinMode(button6, INPUT_PULLUP);

  // Ethernet and MQTT Setup
  networkSetup();
  mqttSetup();

  Serial.println("Music puzzle ready!");
}

void loop()
{
  sendDataMQTT(); // Ensure MQTT stays connected

  // Read and debounce all buttons
  checkButton(button1, buttonState1, lastButtonState1, lastDebounceTime1, '1');
  checkButton(button2, buttonState2, lastButtonState2, lastDebounceTime2, '2');
  checkButton(button3, buttonState3, lastButtonState3, lastDebounceTime3, '3');
  checkButton(button4, buttonState4, lastButtonState4, lastDebounceTime4, '4');
  checkButton(button5, buttonState5, lastButtonState5, lastDebounceTime5, '5');
  checkButton(button6, buttonState6, lastButtonState6, lastDebounceTime6, '6');

  // Send heartbeat every 5 seconds
  unsigned long currentTime = millis();
  if (currentTime - lastHeartbeat >= heartbeatInterval)
  {
    sendImmediateMQTT("heartbeat");
    lastHeartbeat = currentTime;
    Serial.println("Heartbeat sent");
  }
}

void checkButton(int pin, bool &currentState, bool &lastState, unsigned long &lastDebounceTime, char buttonName)
{
  bool reading = !digitalRead(pin); // Inverted because of pull-up resistor

  if (reading != lastState)
  {
    lastDebounceTime = millis();
  }

  if ((millis() - lastDebounceTime) > debounceDelay)
  {
    if (reading != currentState)
    {
      currentState = reading;

      // Only send message on button press (not release)
      if (currentState)
      {
        // Send button number immediately using ParagonMQTT immediate send
        char buttonMessage[2];
        buttonMessage[0] = buttonName;
        buttonMessage[1] = '\0';
        sendImmediateMQTT(buttonMessage);

        Serial.print("Button ");
        Serial.print(buttonName);
        Serial.println(" pressed!");
      }
    }
  }

  lastState = reading;
}
