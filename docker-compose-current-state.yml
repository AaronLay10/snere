name: sentient
services:
  device-monitor:
    build:
      context: /opt/sentient/services/device-monitor
      dockerfile: Dockerfile
      args:
        NODE_ENV: development
    container_name: sentient-device-monitor
    depends_on:
      mosquitto:
        condition: service_healthy
        required: true
      postgres:
        condition: service_healthy
        required: true
    environment:
      DATABASE_URL: postgresql://sentient_dev:dev_password@postgres:5432/sentient_dev
      MQTT_BROKER_URL: mqtt://mosquitto:1883
      MQTT_PASSWORD: dev_password
      MQTT_URL: mqtt://mosquitto:1883
      MQTT_USER: paragon_devices
      NODE_ENV: development
      PORT: "3003"
    healthcheck:
      test:
        - CMD-SHELL
        - wget --no-verbose --tries=1 --spider http://localhost:3003/health || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        labels: service=device-monitor
        max-file: "3"
        max-size: 10m
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 3003
        published: "3003"
        protocol: tcp
    restart: unless-stopped
  grafana:
    container_name: sentient-grafana
    depends_on:
      loki:
        condition: service_started
        required: true
      prometheus:
        condition: service_started
        required: true
    environment:
      GF_INSTALL_PLUGINS: ""
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SERVER_ROOT_URL: https://sentientengine.ai/grafana
      GF_USERS_ALLOW_SIGN_UP: "false"
    healthcheck:
      test:
        - CMD-SHELL
        - curl -f http://127.0.0.1:3000/health || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    image: grafana/grafana:latest
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 3000
        published: "3200"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/sentient/config/grafana/datasources
        target: /etc/grafana/provisioning/datasources
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/config/grafana/dashboards
        target: /etc/grafana/provisioning/dashboards
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/volumes/grafana-data
        target: /var/lib/grafana
        bind:
          create_host_path: true
  loki:
    command:
      - -config.file=/etc/loki/loki-config.yml
    container_name: sentient-loki
    healthcheck:
      test:
        - CMD-SHELL
        - wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    image: grafana/loki:latest
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 3100
        published: "3100"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/sentient/config/loki/loki-config.yml
        target: /etc/loki/loki-config.yml
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/volumes/loki-data
        target: /loki
        bind:
          create_host_path: true
  mosquitto:
    container_name: sentient-mosquitto
    healthcheck:
      test:
        - CMD-SHELL
        - mosquitto_sub -h localhost -p 1883 -u paragon_devices -P dev_password -t '$$SYS/#' -C 1 -W 3 || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    image: eclipse-mosquitto:2
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 1883
        published: "1883"
        protocol: tcp
      - mode: ingress
        target: 9001
        published: "9001"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/sentient/config/mosquitto/mosquitto.conf
        target: /mosquitto/config/mosquitto.conf
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/config/mosquitto/mosquitto_passwd
        target: /mosquitto/config/mosquitto_passwd
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/config/mosquitto/mosquitto.acl
        target: /mosquitto/config/mosquitto.acl
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/volumes/mosquitto-data
        target: /mosquitto/data
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/volumes/mosquitto-logs
        target: /mosquitto/log
        bind:
          create_host_path: true
  nginx:
    container_name: sentient-nginx
    depends_on:
      device-monitor:
        condition: service_started
        required: true
      scene-executor:
        condition: service_started
        required: true
      sentient-api-1:
        condition: service_started
        required: true
      sentient-api-2:
        condition: service_started
        required: true
      sentient-web:
        condition: service_started
        required: true
    healthcheck:
      test:
        - CMD-SHELL
        - wget --no-verbose --tries=1 --spider http://127.0.0.1/health || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    image: nginx:1.25-alpine
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 80
        published: "80"
        protocol: tcp
      - mode: ingress
        target: 443
        published: "443"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/sentient/config/nginx/nginx.conf
        target: /etc/nginx/nginx.conf
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/config/nginx/conf.d
        target: /etc/nginx/conf.d
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/config/nginx/ssl
        target: /etc/nginx/ssl
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/volumes/nginx-logs
        target: /var/log/nginx
        bind:
          create_host_path: true
  postgres:
    container_name: sentient-postgres
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_DB: sentient_dev
      POSTGRES_PASSWORD: dev_password
      POSTGRES_USER: sentient_dev
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U sentient_dev -d sentient_dev
      timeout: 5s
      interval: 10s
      retries: 5
    image: postgres:16-alpine
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 5432
        published: "5432"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/sentient/volumes/postgres-data
        target: /var/lib/postgresql/data
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/config/postgres/init
        target: /docker-entrypoint-initdb.d
        read_only: true
        bind:
          create_host_path: true
  prometheus:
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --storage.tsdb.retention.time=30d
    container_name: sentient-prometheus
    healthcheck:
      test:
        - CMD-SHELL
        - wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    image: prom/prometheus:latest
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 9090
        published: "9090"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/sentient/config/prometheus/prometheus.yml
        target: /etc/prometheus/prometheus.yml
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/config/prometheus/alerts
        target: /etc/prometheus/alerts
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /opt/sentient/volumes/prometheus-data
        target: /prometheus
        bind:
          create_host_path: true
  promtail:
    command:
      - -config.file=/etc/promtail/promtail-config.yml
    container_name: sentient-promtail
    depends_on:
      loki:
        condition: service_started
        required: true
    image: grafana/promtail:latest
    networks:
      sentient-internal: null
    restart: unless-stopped
    volumes:
      - type: bind
        source: /opt/sentient/config/promtail/promtail-config.yml
        target: /etc/promtail/promtail-config.yml
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /var/lib/docker/containers
        target: /var/lib/docker/containers
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
        bind:
          create_host_path: true
  scene-executor:
    build:
      context: /opt/sentient/services/executor-engine
      dockerfile: Dockerfile
      args:
        NODE_ENV: development
    container_name: sentient-scene-executor
    depends_on:
      mosquitto:
        condition: service_healthy
        required: true
      postgres:
        condition: service_healthy
        required: true
    environment:
      DATABASE_URL: postgresql://sentient_dev:dev_password@postgres:5432/sentient_dev
      MQTT_BROKER_URL: mqtt://mosquitto:1883
      MQTT_PASSWORD: dev_password
      MQTT_USER: paragon_devices
      NODE_ENV: development
      PORT: "3004"
    healthcheck:
      test:
        - CMD-SHELL
        - wget --no-verbose --tries=1 --spider http://localhost:3004/health || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        labels: service=scene-executor
        max-file: "3"
        max-size: 10m
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 3004
        published: "3004"
        protocol: tcp
    restart: unless-stopped
  sentient-api-1:
    build:
      context: /opt/sentient/services/api
      dockerfile: Dockerfile
      args:
        NODE_ENV: development
    container_name: sentient-api-1
    depends_on:
      mosquitto:
        condition: service_healthy
        required: true
      postgres:
        condition: service_healthy
        required: true
    environment:
      DATABASE_URL: postgresql://sentient_dev:dev_password@postgres:5432/sentient_dev
      JWT_SECRET: dev_jwt_secret_change_in_production
      MQTT_BROKER_URL: mqtt://mosquitto:1883
      MQTT_PASSWORD: dev_password
      MQTT_USER: paragon_devices
      NODE_ENV: development
      PORT: "3000"
      SESSION_SECRET: dev_session_secret_change_in_production
    healthcheck:
      test:
        - CMD-SHELL
        - curl -f http://127.0.0.1:3000/health || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        labels: service=sentient-api,instance=1
        max-file: "3"
        max-size: 10m
    networks:
      sentient-internal: null
    restart: unless-stopped
  sentient-api-2:
    build:
      context: /opt/sentient/services/api
      dockerfile: Dockerfile
      args:
        NODE_ENV: development
    container_name: sentient-api-2
    depends_on:
      mosquitto:
        condition: service_healthy
        required: true
      postgres:
        condition: service_healthy
        required: true
    environment:
      DATABASE_URL: postgresql://sentient_dev:dev_password@postgres:5432/sentient_dev
      JWT_SECRET: dev_jwt_secret_change_in_production
      MQTT_BROKER_URL: mqtt://mosquitto:1883
      MQTT_PASSWORD: dev_password
      MQTT_USER: paragon_devices
      NODE_ENV: development
      PORT: "3000"
      SESSION_SECRET: dev_session_secret_change_in_production
    healthcheck:
      test:
        - CMD-SHELL
        - curl -f http://127.0.0.1:3000/health || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        labels: service=sentient-api,instance=2
        max-file: "3"
        max-size: 10m
    networks:
      sentient-internal: null
    restart: unless-stopped
  sentient-web:
    build:
      context: /opt/sentient/services/sentient-web
      dockerfile: Dockerfile
      args:
        NODE_ENV: development
        VITE_API_URL: http://localhost
    container_name: sentient-web
    environment:
      NODE_ENV: development
      PORT: "3002"
    healthcheck:
      test:
        - CMD-SHELL
        - curl -f http://127.0.0.1:3002 || exit 1
      timeout: 10s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        labels: service=sentient-web
        max-file: "3"
        max-size: 10m
    networks:
      sentient-internal: null
    ports:
      - mode: ingress
        target: 3002
        published: "3002"
        protocol: tcp
    restart: unless-stopped
networks:
  sentient-internal:
    name: sentient_sentient-internal
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
